# Руководство по развертыванию смарт-контрактов (Deployment Guide)

Данное руководство описывает процесс подготовки и развертывания смарт-контрактов проекта в блокчейн-сети.

---

## 1. Первоначальная настройка окружения (`.env`)

Перед началом работы необходимо настроить переменные окружения. Создайте файл `.env` в корне проекта (вы можете скопировать `.env.example`, если он есть) и заполните следующие обязательные поля:

```env
# Приватный ключ кошелька-деплоера (убедитесь, что на нем есть нативные токены сети для оплаты газа)
PRIVATE_KEY=your_private_key_here

# API ключи для подключения к RPC узлам провайдеров (в зависимости от целевой сети)
BINANCE_URL=your_binance_url

# API ключи обозревателей блоков для автоматической верификации контрактов
BSCSCAN_API_KEY=your_bscscan_key
```

---

## 2. Первоначальная установка зависимостей

Убедитесь, что у вас установлен Node.js. Затем установите все необходимые зависимости контрактов, выполнив одну из следующих команд в корне проекта:

Используя **npm**:
```bash
npm install
```

Затем скомпилируйте контракты:
```bash
npx hardhat compile
```

---

## 3. Настройка мультисига (Gnosis Safe) и Конфигурации

Перед деплоем важно правильно указать адреса управляющих мультисиг-кошельков (Gnosis Safe). Эти кошельки получат все основные права администраторов (DEFAULT_ADMIN_ROLE, MINTER_ROLE и т.д.) после инициализации контрактов.

### Шаг 3.1: Изменение `GNOSIS_WALLET` в смарт-контрактах
Измените эту константу на ваш актуальный адрес мультисига перед деплоем:
- `contracts/BNH.sol`
- `contracts/BlockList.sol`
- `contracts/DOPPY.sol`
- `contracts/Treasury.sol`

А также обновите `config/ContractsConfig.ts`, `config/ContractsConfigINT.ts` и `config/ContractsConfigProd.ts` адреса multiSigAddress (это тот же GNOSIS_WALLET, что и в контракте)

---

## 4. Развертывание контрактов по-отдельности (Пошаговый деплой)
Контракты должны быть развернуты в следующей последовательности:
1. BlockList
2. DOPPY
3. BNH
4. Treasury

Система логически разделена на несколько скриптов для управляемого деплоя. Важное правило при пошаговом деплое: **после развертывания каждого контракта вы должны скопировать адреса его ПРОКСИ (Proxy), имплементации (Implementation) и АДМИНИСТРАТОРА (Admin), и вставить в конфигурационные файлы из пункта 3.1**, так как следующие контракты зависят от предыдущих.

### Скрипты деплоя:
Все скрипты находятся в папке `deploy_instructions`

**1. BlockList (`npx hardhat run deploy_instructions/2_deploy_blocklist.ts --network bsc`)**
- Деплоит контракт черного списка.

**2. DOPPY (`npx hardhat run deploy_instructions/3_deploy_doppy.ts --network bsc`)**
- Деплоит токен DOPPY.

**3. BNH (`npx hardhat run deploy_instructions/4_deploy_bnh.ts --network bsc`)**
- Деплоит токен BNH.

**4. Treasury (`npx hardhat run deploy_instructions/7_deploy_treasury.ts --network bsc`)**
- Деплоит казначейство. Этот контракт **строго требует**, чтобы адреса DOPPY и BNH уже были задеплоены и правильно записаны в конфигурацию, так как `Treasury` обращается к ним при инициализации. А также в самом скрипте необходимо прописать адреса recipient, USDT и signer

---

## 5. Общий скрипт деплоя (`deploy_all.ts`)

Для удобства и автоматизации был создан единый скрипт `deploy_instructions/deploy_all.ts`. Он делает всю вышеописанную работу (развертывание контрактов) за один запуск, самостоятельно передавая адреса от одних контрактов к другим "на лету", минуя необходимость ручного копирования в конфиг между шагами.

### Как использовать:
Перед деплоем в самом скрипте необходимо прописать адреса RECIPIENT_ADDRESS, USDT_ADDRESS и SIGNER_ADDRESS в 4 пункте (51, 52, 53 строки)

Выполните команду:
```bash
npx hardhat run deploy_instructions/deploy_all.ts --network bsc
```

### Внутренняя логика `deploy_all.ts`:
1. Скрипт последовательно деплоит все 4 контракта: `BlockList` -> `DOPPY` -> `BNH` -> `Treasury`.
2. Адреса развернутых `DOPPY` и `BNH` программно передаются в функцию инициализации `Treasury`, поэтому ручное редактирование конфига *в процессе деплоя* не требуется.
3. В скрипте заложена пауза в 2 минуты (~120 сек), чтобы подождать, пока блокчейн-эксплорер (BscScan) проиндексирует новые адреса.
4. После ожидания скрипт автоматически вызывает систему верификации исходного кода для всех только что развернутых контрактов.

**Действие после деплоя `deploy_all.ts`:**
В самом конце в консоль будет выведена сводка всех адресов. Вам **обязательно** нужно взять эти финальные адреса и зафиксировать их в `config/ContractsConfig.ts` (и в `config/ContractsConfigINT.ts`, `config/ContractsConfigProd.ts`) для дальнейшей работы (например, для фронтенда или других сервисов).

---

## 6. Ручная привязка BlockList после деплоя

Так как во время `initialize` контрактов DOPPY и BNH управление (`DEFAULT_ADMIN_ROLE`) немедленно передается кошельку **Gnosis Safe** (константе `GNOSIS_WALLET`), EOA, который деплоил, больше не имеет прав менять настройки.

Поэтому, **сразу после завершения деплоя всех смарт-контрактов**, необходимо вручную установить адрес `BlockList` в контрактах DOPPY и BNH:

**Что нужно сделать:**
Через интерфейс Gnosis Safe (сбор подписей) отправить транзакции вызова функции `setBlockList(address _blockList)` в развернутые прокси-контракты DOPPY и BNH.

**Кто должен это сделать:**
Владельцы кошелька **Gnosis Safe** (те, чьи адреса заложены в логике мультисига).

---

## 7. Снятие ограничений BlockList для системных кошельков (Добавление исключений)

**Что нужно сделать:**
Через интерфейс Gnosis Safe вызвать функцию `addContractToExclusionList(address _contract)` в развернутом прокси-контракте **BlockList** для каждого из системных кошельков. (Это исключает адреса из проверки лимитов на переводы).

**Для каких адресов нужно установить исключение:**
1. **`GNOSIS_WALLET`** (Сам кошелек администраторов).
2. **`RECIPIENT_ADDRESS`** (Адрес получателя средств/казначейства).
3. **`SIGNER_ADDRESS`** (Адрес подписанта, используемый бэкендом).
4. **Treasury контракт** (Адрес прокси казначейства).
5. Любой другой адрес, который должен быть исключен из лимитов на операции.

**Кто должен это сделать:**
Владельцы кошелька **Gnosis Safe** (те, чьи адреса заложены в логике мультисига).
---

## Важные примечания по ProxyAdmin
В текущей конфигурации деплоя права на обновление смарт-контрактов (ProxyAdmin права) остаются на кошельке деплоера, который вызывал скрипты (ваш EOA кошелек).
